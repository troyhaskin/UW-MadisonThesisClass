%<*UserGuide>


%</UserGuide>
%
%
%
%
%
%
%<*Implementation>
%<<Verbatim
%   \iffalse
%<*Code>
%   \fi
%
% \UWModule{Relative Directory Input}
%
%
%   \UWSubModule{Declarations and Initializations}
%   Variable declarations and default initializations for Chapter directories.
%    \begin{macrocode}
\int_new:N  \g__UWMad_RelativeDirectory_Chapter_Count_int
\tl_new:N   \g__UWMad_RelativeDirectory_Chapter_CurrentPath_tl
\tl_new:N   \g__UWMad_RelativeDirectory_Chapter_CurrentName_tl
\tl_new:N   \g__UWMad_RelativeDirectory_Chapter_ParentPath_tl
\tl_gset:Nn \g__UWMad_RelativeDirectory_Chapter_ParentPath_tl {}
\bool_new:N       \g__UWMad_RelativeDirectory_IsChapter_bool
\bool_gset_true:N \g__UWMad_RelativeDirectory_IsChapter_bool
%    \end{macrocode}
%
%   Variable declarations and default initializations for Section directories.
%    \begin{macrocode}
\int_new:N  \g__UWMad_RelativeDirectory_Section_Count_int
\tl_new:N   \g__UWMad_RelativeDirectory_Section_CurrentPath_tl
\tl_new:N   \g__UWMad_RelativeDirectory_Section_CurrentName_tl
\tl_new:N   \g__UWMad_RelativeDirectory_Section_ParentPath_tl
\tl_gset:Nn \g__UWMad_RelativeDirectory_Section_ParentPath_tl {
    \g__UWMad_RelativeDirectory_Chapter_CurrentPath_tl/
}
\bool_new:N        \g__UWMad_RelativeDirectory_IsSection_bool
\bool_gset_false:N \g__UWMad_RelativeDirectory_IsSection_bool
%    \end{macrocode}
%
%   Variable declarations and default initializations for Subsection
%   directories.
%    \begin{macrocode}
\int_new:N  \g__UWMad_RelativeDirectory_Subsection_Count_int
\tl_new:N   \g__UWMad_RelativeDirectory_Subsection_CurrentPath_tl
\tl_new:N   \g__UWMad_RelativeDirectory_Subsection_CurrentName_tl
\tl_new:N   \g__UWMad_RelativeDirectory_Subsection_ParentPath_tl
\tl_gset:Nn \g__UWMad_RelativeDirectory_Subsection_ParentPath_tl {
    \g__UWMad_RelativeDirectory_Chapter_CurrentPath_tl/
    \g__UWMad_RelativeDirectory_Section_CurrentPath_tl/
}
\bool_new:N        \g__UWMad_RelativeDirectory_IsSubsection_bool
\bool_gset_false:N \g__UWMad_RelativeDirectory_IsSubsection_bool
%    \end{macrocode}
%
%   Miscellaneous variable initializations for the system
%    \begin{macrocode}
\tl_const:Nn \c__UWMad_RelativeDirectory_None_tl {none}
\tl_const:Nn \c__UWMad_RelativeDirectory_Same_tl {same}
\tl_const:Nn \c__UWMad_RelativeDirectory_Increment_tl {increment}
\tl_new:N    \g__UWMad_RelativeDirectory_File_CurrentName_tl
\tl_new:N    \g__UWMad_RelativeDirectory_OptionalPath_tl
\seq_new:N   \g__UWMad_RelativeDirectory_PathStack_seq
\bool_new:N  \g__UWMad_RelativeDirectory_IsFileFound_bool
%    \end{macrocode}
%
%
%
%   Miscellaneous control sequence initializations for the system.
%    \begin{macrocode}
\cs_new:Nn \UWMad_RelativeDirectory_Chapter_SetName:    {}
\cs_new:Nn \UWMad_RelativeDirectory_Section_SetName:    {}
\cs_new:Nn \UWMad_RelativeDirectory_Subsection_SetName: {}
%    \end{macrocode}
%
%
%   \UWSubModule{Back End Code}
%
%   Directory name-setting functions.
%    \begin{macrocode}
\cs_new:Nn \UWMad_RelativeDirectory_SetName_None: {}
\cs_new:Nn \UWMad_RelativeDirectory_SetName_Increment:n {
    \int_gincr:c {g__UWMad_RelativeDirectory_ #1 _Count_int}
    \tl_gset:cn   {g__UWMad_RelativeDirectory_ #1 _CurrentName_tl} {
        \tl_use:c {g__UWMad_RelativeDirectory_ #1 _Prefix_tl}
        \int_to_arabic:n{
            \int_use:c{g__UWMad_RelativeDirectory_ #1 _Count_int}
        }
        \tl_use:c {g__UWMad_RelativeDirectory_ #1 _Suffix_tl}
    }
}
\cs_new:Nn \UWMad_RelativeDirectory_SetName_Same:n {
    \tl_gset:cn   {g__UWMad_RelativeDirectory_ #1 _CurrentName_tl} {
        \tl_use:c {g__UWMad_RelativeDirectory_ #1 _Prefix_tl}
        \g__UWMad_RelativeDirectory_File_CurrentName_tl
        \tl_use:c {g__UWMad_RelativeDirectory_ #1 _Suffix_tl}
    }
}
%    \end{macrocode}
%
%
%   Name and path setter.
%    \begin{macrocode}
\cs_new:Nn \UWMad_RelativeDirectory_SetNameAndPath:n {

    \tl_gclear:c {g__UWMad_RelativeDirectory_ #1 _CurrentName_tl}
    \tl_gclear:c {g__UWMad_RelativeDirectory_ #1 _CurrentPath_tl}

    \tl_if_blank:VTF {\g__UWMad_RelativeDirectory_OptionalPath_tl} {
        \use:c {UWMad_RelativeDirectory_ #1 _SetName:}
    } {
        \tl_gset_eq:cN
            {g__UWMad_RelativeDirectory_ #1 _CurrentName_tl}
            \g__UWMad_RelativeDirectory_OptionalPath_tl
    }
    \tl_gset:cn   {g__UWMad_RelativeDirectory_ #1 _CurrentPath_tl} {
        \tl_use:c {g__UWMad_RelativeDirectory_ #1 _ParentPath_tl}
        \tl_use:c {g__UWMad_RelativeDirectory_ #1 _CurrentName_tl}
    }
}
%    \end{macrocode}
%
%
%   Path stack updater.
%    \begin{macrocode}
\cs_new:Nn \UWMad_RelativeDirectory_UpdatePathStack:n {

    \bool_if:cTF {g__UWMad_RelativeDirectory_Is #1 _bool} {
        \seq_gclear:N \g__UWMad_RelativeDirectory_PathStack_seq
    } { }

    \UWMad_RelativeDirectory_SetNameAndPath:n{#1}

    \tl_gset_eq:Nc
        \g_tmpa_tl
        {g__UWMad_RelativeDirectory_ #1 _CurrentName_tl}
    \tl_if_blank:VTF {\g_tmpa_tl} { } {
        \seq_gpush:NV \g__UWMad_RelativeDirectory_PathStack_seq {
            \tl_use:c {g__UWMad_RelativeDirectory_ #1 _CurrentPath_tl}
        }
    }

}
%    \end{macrocode}
%
%
%   Two file inputers: one cycles through the current path stack searching
%   for the file from deepest to highest and the other only searches the
%   deepest (i.e., current) directory.
%    \begin{macrocode}
\cs_new:Nn \UWMad_RelativeDirectory_InputFile_CycleThrough: {
    \seq_map_inline:Nn \g__UWMad_RelativeDirectory_PathStack_seq {
        \tl_gset:Nn \g_tmpa_tl {
            ./##1/
            \g__UWMad_RelativeDirectory_File_CurrentName_tl
        }
        \bool_if:NTF \g__UWMad_RelativeDirectory_IsFileFound_bool { } {
            \file_if_exist:nTF { \g_tmpa_tl } {
                \file_input:n{ \g_tmpa_tl }
                \bool_gset_true:N \g__UWMad_RelativeDirectory_IsFileFound_bool
            } { }
        }
    }
}
\cs_new:Nn \UWMad_RelativeDirectory_InputFile_CheckDeepest: {
    
    \seq_get:NN
        \g__UWMad_RelativeDirectory_PathStack_seq
        \g_tmpa_tl
    \tl_gset:Nn \g_tmpb_tl {
            ./\g_tmpa_tl/
            \g__UWMad_RelativeDirectory_File_CurrentName_tl
    }
    \file_if_exist:nTF {g_tmpb_tl} {
        \file_input:n{g_tmpb_tl}
        \bool_gset_true:N \g__UWMad_RelativeDirectory_IsFileFound_bool
    } { }
}
%    \end{macrocode}
%
%
%   This is a wrapper function for the above two functions with two additional
%   behaviors: if the file is not found from the search stack, it will check
%   the topmost \TeX{} directory for the file and issue a warning if it is not
%   found.
%    \begin{macrocode}
\msg_new:nnn { UWMadThesis }{ RelativeDirectory / FileNotFound } {
    The~requested~file~'#1'~was~not~found~in~the~current~search~stack~nor~the~
    main~LaTeX~directory~for~the~job~'\c_job_name_tl'.
}
\cs_new:Nn \UWMad_RelativeDirectory_InputFile: {
    \bool_gset_false:N \g__UWMad_RelativeDirectory_IsFileFound_bool

    \bool_if:NTF \g__UWMad_RelativeDirectory_CycleThroughStack_bool {
        \UWMad_RelativeDirectory_InputFile_CycleThrough:
    } {
        \UWMad_RelativeDirectory_InputFile_CheckDeepest:
    }

    \bool_if:NTF \g__UWMad_RelativeDirectory_IsFileFound_bool { } {
        \file_if_exist:nTF {\g__UWMad_RelativeDirectory_File_CurrentName_tl} {
            \file_input:n{ \g__UWMad_RelativeDirectory_File_CurrentName_tl }
            \bool_gset_true:N \g__UWMad_RelativeDirectory_IsFileFound_bool
        } {
            \msg_warning:nnx
                { UWMadThesis }
                { RelativeDirectory / FileNotFound }
                { \g__UWMad_RelativeDirectory_File_CurrentName_tl }
        }
    }
}






\keys_define:nn { UWMadThesis / RelativeDirectory } {
    chapter-directory-prefix    .tl_gset:N =
        \g__UWMad_RelativeDirectory_Chapter_Prefix_tl,
    chapter-directory-suffix    .tl_gset:N =
        \g__UWMad_RelativeDirectory_Chapter_Suffix_tl,
    section-directory-prefix    .tl_gset:N =
        \g__UWMad_RelativeDirectory_Section_Prefix_tl,
    section-directory-suffix    .tl_gset:N =
        \g__UWMad_RelativeDirectory_Section_Suffix_tl,
    subsection-directory-prefix .tl_gset:N =
        \g__UWMad_RelativeDirectory_Subsection_Prefix_tl,
    subsection-directory-suffix .tl_gset:N =
        \g__UWMad_RelativeDirectory_Subsection_Suffix_tl,
    chapter-directory-prefix    .default:n =,
    chapter-directory-suffix    .default:n =,
    section-directory-prefix    .default:n =,
    section-directory-suffix    .default:n =,
    subsection-directory-prefix .default:n =,
    subsection-directory-suffix .default:n =,
%
    chapter-directory-name      .choice:,
    chapter-directory-name      .choice_code:n = {
        \tl_case:NnTF  \l_keys_choice_tl {
            \c__UWMad_RelativeDirectory_None_tl {
                \cs_gset:Nn \UWMad_RelativeDirectory_Chapter_SetName: {
                    \UWMad_RelativeDirectory_SetName_None:
                }
            }
            \c__UWMad_RelativeDirectory_Same_tl {
                \cs_gset:Nn \UWMad_RelativeDirectory_Chapter_SetName: {
                    \UWMad_RelativeDirectory_SetName_Same:n{Chapter}
                }
            }
            \c__UWMad_RelativeDirectory_Increment_tl {
                \cs_gset:Nn \UWMad_RelativeDirectory_Chapter_SetName: {
                    \UWMad_RelativeDirectory_SetName_Increment:n{Chapter}
                }
            }
        } { } { }
    },
    chapter-directory-name .generate_choices:n = {
        increment , same , none
    },
%
    section-directory-name      .choice:,
    section-directory-name      .choice_code:n = {
        \tl_case:NnTF  \l_keys_choice_tl {
            \c__UWMad_RelativeDirectory_None_tl {
                \cs_gset:Nn \UWMad_RelativeDirectory_Section_SetName: {
                    \UWMad_RelativeDirectory_SetName_None:
                }
            }
            \c__UWMad_RelativeDirectory_Same_tl {
                \cs_gset:Nn \UWMad_RelativeDirectory_Section_SetName: {
                    \UWMad_RelativeDirectory_SetName_Same:n{Section}
                }
            }
            \c__UWMad_RelativeDirectory_Increment_tl {
                \cs_gset:Nn \UWMad_RelativeDirectory_Section_SetName: {
                    \UWMad_RelativeDirectory_SetName_Increment:n{Section}
                }
            }
        } { } { }
    },
    section-directory-name .generate_choices:n = {
        increment , same , none
    },
%
    subsection-directory-name      .choice:,
    subsection-directory-name      .choice_code:n = {
        \tl_case:NnTF  \l_keys_choice_tl {
            \c__UWMad_RelativeDirectory_None_tl {
                \cs_gset:Nn \UWMad_RelativeDirectory_Subsection_SetName: {
                    \UWMad_RelativeDirectory_SetName_None:
                }
            }
            \c__UWMad_RelativeDirectory_Same_tl {
                \cs_gset:Nn \UWMad_RelativeDirectory_Subsection_SetName: {
                    \UWMad_RelativeDirectory_SetName_Same:n{Subsection}
                }
            }
            \c__UWMad_RelativeDirectory_Increment_tl {
                \cs_gset:Nn \UWMad_RelativeDirectory_Subsection_SetName: {
                    \UWMad_RelativeDirectory_SetName_Increment:n{Subsection}
                }
            }
        } { } { }
    },
    subsection-directory-name .generate_choices:n = {
        increment , same , none
    },
%
    chapter-directory-name    .default:n = none,
    section-directory-name    .default:n = none,
    subsection-directory-name .default:n = none,
%
    cycle-through-paths .bool_gset:N =
        \g__UWMad_RelativeDirectory_CycleThroughStack_bool,
    cycle-through-paths .default:n = true
}
\keys_set:nn { UWMadThesis / RelativeDirectory } {
    chapter-directory-prefix,
    chapter-directory-suffix,
    section-directory-prefix,
    section-directory-suffix,
    subsection-directory-prefix,
    subsection-directory-suffix,
    chapter-directory-name,
    section-directory-name,
    subsection-directory-name,
    cycle-through-paths
}

\DeclareDocumentCommand \RelativeDirectorySetup { m } {
    \keys_set:nn { UWMadThesis / RelativeDirectory } { #1 }
}





\DeclareDocumentCommand \IncludeChapter { o m } {

    \IfNoValueTF { #1 } { } {
        \tl_gset:Nn \g__UWMad_RelativeDirectory_OptionalPath_tl {#1}
    }
    \tl_gset:Nn \g__UWMad_RelativeDirectory_File_CurrentName_tl {#2}

    \UWMad_RelativeDirectory_UpdatePathStack:n{Chapter}
    \UWMad_RelativeDirectory_InputFile:

}

\DeclareDocumentCommand \IncludeSection { o m } {

    \IfNoValueTF { #1 } { } {
        \tl_gset:Nn \g__UWMad_RelativeDirectory_OptionalPath_tl {#1}
    }
    \tl_gset:Nn \g__UWMad_RelativeDirectory_File_CurrentName_tl {#2}

    \UWMad_RelativeDirectory_UpdatePathStack:n{Section}
    \UWMad_RelativeDirectory_InputFile:

}

\DeclareDocumentCommand \IncludeSubsection { o m } {

    \IfNoValueTF { #1 } { } {
        \tl_gset:Nn \g__UWMad_RelativeDirectory_OptionalPath_tl {#1}
    }
    \tl_gset:Nn \g__UWMad_RelativeDirectory_File_CurrentName_tl {#2}

    \UWMad_RelativeDirectory_UpdatePathStack:n{Subsection}
    \UWMad_RelativeDirectory_InputFile:

}


%    \end{macrocode}
%
%   \iffalse
%</Code>
%   \fi
%Verbatim
%</Implementation>