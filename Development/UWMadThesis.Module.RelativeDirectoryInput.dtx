%<*UserGuide>


%</UserGuide>
%
%
%
%
%
%
%<*Implementation>
%<<Verbatim
%   \iffalse
%<*Code>
%   \fi
%
% \UWModule{Relative Directory Input}
%
%
%
%    \begin{macrocode}

\cs_new:Nn \UWMad_RelativeDirectory_SetName_Increment:n {
    \int_gincr:c {g__UWMad_RelativeDirectory_ #1 _Count_int}
    \int_gset_eq:Nc
        \g_tmpa_int
        {g__UWMad_RelativeDirectory_ #1 _Count_int}
    \tl_gset:cn   {g__UWMad_RelativeDirectory_ #1 _CurrentName_tl} {
        \tl_use:c {g__UWMad_RelativeDirectory_ #1 _Prefix_tl}
        \int_to_arabic:n{\g_tmpa_int}
        \tl_use:c {g__UWMad_RelativeDirectory_ #1 _Suffix_tl}
    }
}
\cs_new:Nn \UWMad_RelativeDirectory_SetName_Same:n {
    \tl_gset:cn   {g__UWMad_RelativeDirectory_ #1 _CurrentName_tl} {
        \tl_use:c {g__UWMad_RelativeDirectory_ #1 _Prefix_tl}
        \g__UWMad_RelativeDirectory_FileName_Current_tl
        \tl_use:c {g__UWMad_RelativeDirectory_ #1 _Suffix_tl}
    }
}


\int_new:N  \g__UWMad_RelativeDirectory_Chapter_Count_int
\int_new:N  \g__UWMad_RelativeDirectory_Section_Count_int
\int_new:N  \g__UWMad_RelativeDirectory_Subsection_Count_int
\tl_new:N   \g__UWMad_RelativeDirectory_Chapter_CurrentPath_tl
\tl_new:N   \g__UWMad_RelativeDirectory_Chapter_CurrentName_tl
\tl_new:N   \g__UWMad_RelativeDirectory_Section_CurrentPath_tl
\tl_new:N   \g__UWMad_RelativeDirectory_Section_CurrentName_tl
\tl_new:N   \g__UWMad_RelativeDirectory_Subsection_CurrentPath_tl
\tl_new:N   \g__UWMad_RelativeDirectory_Subsection_CurrentName_tl
\tl_new:N   \g__UWMad_RelativeDirectory_FileName_Current_tl
\seq_new:N  \g__UWMad_RelativeDirectory_PathStack_seq
\bool_new:N \g__UWMad_RelativeDirectory_IsFileFound_bool

\bool_new:N       \g__UWMad_RelativeDirectory_IsChapter_bool
\bool_new:N       \g__UWMad_RelativeDirectory_IsSection_bool
\bool_new:N       \g__UWMad_RelativeDirectory_IsSubsection_bool
\bool_gset_true:N \g__UWMad_RelativeDirectory_IsChapter_bool

\tl_new:N   \g__UWMad_RelativeDirectory_Chapter_ParentPath_tl
\tl_new:N   \g__UWMad_RelativeDirectory_Section_ParentPath_tl
\tl_new:N   \g__UWMad_RelativeDirectory_Subsection_ParentPath_tl
\tl_gset:Nn \g__UWMad_RelativeDirectory_Chapter_ParentPath_tl {}
\tl_gset:Nn \g__UWMad_RelativeDirectory_Section_ParentPath_tl {
    \g__UWMad_RelativeDirectory_Chapter_CurrentPath_tl/
}
\tl_gset:Nn \g__UWMad_RelativeDirectory_Subsection_ParentPath_tl {
    \g__UWMad_RelativeDirectory_Chapter_CurrentPath_tl/
    \g__UWMad_RelativeDirectory_Section_CurrentPath_tl/
}


\cs_new:Nn \UWMad_RelativeDirectory_UpdatePathStack:nn {

    \bool_if:cTF {g__UWMad_RelativeDirectory_Is #1 _bool} {
        \seq_gclear:N \g__UWMad_RelativeDirectory_PathStack_seq
    } { }

    \UWMad_RelativeDirectory_SetNameAndPath:nn{#1}{#2}

    \tl_gset_eq:Nc
        \g_tmpa_tl
        {g__UWMad_RelativeDirectory_ #1 _CurrentPath_tl}
    \tl_if_blank:nTF {\g_tmpa_tl} { } {
        \seq_gpush:Nn \g__UWMad_RelativeDirectory_PathStack_seq {
            \tl_use:c {g__UWMad_RelativeDirectory_ #1 _CurrentPath_tl}
        }
    }

}



\cs_new:Nn \UWMad_RelativeDirectory_SetNameAndPath:nn {

    \tl_gclear:c {g__UWMad_RelativeDirectory_ #1 _CurrentName_tl}
    \tl_gclear:c {g__UWMad_RelativeDirectory_ #1 _CurrentPath_tl}

    \tl_gset:Nn \g__UWMad_RelativeDirectory_FileName_Current_tl {#2}
    \use:c {UWMad_RelativeDirectory_ #1 _SetName:}

    \tl_gset:cn   {g__UWMad_RelativeDirectory_ #1 _CurrentPath_tl} {
        \tl_use:c {g__UWMad_RelativeDirectory_ #1 _ParentPath_tl}
        \tl_use:c {g__UWMad_RelativeDirectory_ #1 _CurrentName_tl}
    }
    \typeout{!!!!!!!!!!!!!!!!!!!!!!!!!!!!! \tl_use:c {g__UWMad_RelativeDirectory_ #1 _CurrentPath_tl}}
}

\cs_new:Nn \UWMad_RelativeDirectory_InputFile:n {
    \bool_gset_false:N \g__UWMad_RelativeDirectory_IsFileFound_bool
    
    \seq_map_inline:Nn \g__UWMad_RelativeDirectory_PathStack_seq {
        \bool_if:NTF \g__UWMad_RelativeDirectory_IsFileFound_bool { } {
            \file_if_exist:nTF {./##1/#1} {
                \file_input:n{./##1/#1}
                \bool_gset_true:N \g__UWMad_RelativeDirectory_IsFileFound_bool
            } { }
        }
    }

    \bool_if:NTF \g__UWMad_RelativeDirectory_IsFileFound_bool { } {
        \typeout{******************** FILE NOT FOUND *******************}
    }
}






\keys_define:nn { UWMadThesis / RelativeDirectory } {
    chapter-directory-prefix    .tl_gset:N =
        \g__UWMad_RelativeDirectory_Chapter_Prefix_tl,
    chapter-directory-suffix    .tl_gset:N =
        \g__UWMad_RelativeDirectory_Chapter_Suffix_tl,
    section-directory-prefix    .tl_gset:N =
        \g__UWMad_RelativeDirectory_Section_Prefix_tl,
    section-directory-suffix    .tl_gset:N =
        \g__UWMad_RelativeDirectory_Section_Suffix_tl,
    subsection-directory-prefix .tl_gset:N =
        \g__UWMad_RelativeDirectory_Subsection_Prefix_tl,
    subsection-directory-suffix .tl_gset:N =
        \g__UWMad_RelativeDirectory_Subsection_Suffix_tl,
    chapter-directory-prefix    .default:n =,
    chapter-directory-suffix    .default:n =,
    section-directory-prefix    .default:n =,
    section-directory-suffix    .default:n =,
    subsection-directory-prefix .default:n =,
    subsection-directory-suffix .default:n =,
%
    chapter-directory-name      .choice:,
    chapter-directory-name      .choice_code:n = {
        \int_compare:nNnTF {\l_keys_choice_int} = {1} {
            \cs_gset:Nn \UWMad_RelativeDirectory_Chapter_SetName: {
                \UWMad_RelativeDirectory_SetName_Increment:n{Chapter}
            }
        } {
            \cs_gset:Nn \UWMad_RelativeDirectory_Chapter_SetName: {
                \UWMad_RelativeDirectory_SetName_Same:n{Chapter}
            }
        }
    },
    chapter-directory-name .generate_choices:n = {
        increment , same
    },
%
    section-directory-name      .choice:,
    section-directory-name      .choice_code:n = {
        \int_compare:nNnTF {\l_keys_choice_int} = {1} {
            \cs_gset:Nn \UWMad_RelativeDirectory_Section_SetName: {
                \UWMad_RelativeDirectory_SetName_Increment:n{Section}
            }
        } {
            \cs_gset:Nn \UWMad_RelativeDirectory_Section_SetName: {
                \UWMad_RelativeDirectory_SetName_Same:n{Section}
            }
        }
    },
    section-directory-name .generate_choices:n = {
        increment , same
    },
%
    subsection-directory-name      .choice:,
    subsection-directory-name      .choice_code:n = {
        \int_compare:nNnTF {\l_keys_choice_int} = {1} {
            \cs_gset:Nn \UWMad_RelativeDirectory_Subsection_SetName: {
                \UWMad_RelativeDirectory_SetName_Increment:n{Subsection}
            }
        } {
            \cs_gset:Nn \UWMad_RelativeDirectory_Subsection_SetName: {
                \UWMad_RelativeDirectory_SetName_Same:n{Subsection}
            }
        }
    },
    subsection-directory-name .generate_choices:n = {
        increment , same
    },
%
    chapter-directory-name    .default:n = same,
    section-directory-name    .default:n = same,
    subsection-directory-name .default:n = same,
%
    cycle-through-paths .bool_gset:N =
        \g__UWMad_RelativeDirectory_CycleThroughStack_bool,
    cycle-through-paths .default:n = true
}
\keys_set:nn { UWMadThesis / RelativeDirectory } {
    chapter-directory-prefix,
    chapter-directory-suffix,
    section-directory-prefix,
    section-directory-suffix,
    subsection-directory-prefix,
    subsection-directory-suffix,
    chapter-directory-name,
    section-directory-name,
    subsection-directory-name,
    cycle-through-paths
}

\DeclareDocumentCommand \RelativeDirectorySetup { m } {
    \keys_set:nn { UWMadThesis / RelativeDirectory } { #1 }
}





\DeclareDocumentCommand \IncludeChapter { o m } {

    \IfNoValueTF { #1 } {
        \UWMad_RelativeDirectory_UpdatePathStack:nn{Chapter}{}
    } {
        \UWMad_RelativeDirectory_UpdatePathStack:nn{Chapter}{#1}
    }
    \UWMad_RelativeDirectory_InputFile:n {#2}

}

\DeclareDocumentCommand \IncludeSection { o m } {

    \IfNoValueTF { #1 } {
        \UWMad_RelativeDirectory_UpdatePathStack:nn{Section}{}
    } {
        \UWMad_RelativeDirectory_UpdatePathStack:nn{Section}{#1}
    }
    \UWMad_RelativeDirectory_InputFile:n {#2}

}

\DeclareDocumentCommand \IncludeSubsection { o m } {

    \IfNoValueTF { #1 } {
        \UWMad_RelativeDirectory_UpdatePathStack:nn{Subsection}{}
    } {
        \UWMad_RelativeDirectory_UpdatePathStack:nn{SubSection}{#1}
    }
    \UWMad_RelativeDirectory_InputFile:n {#2}

}


%    \end{macrocode}
%
%   \iffalse
%</Code>
%   \fi
%Verbatim
%</Implementation>